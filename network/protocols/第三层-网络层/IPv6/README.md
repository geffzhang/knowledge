# IPv6 协议

## 相关概念

# IPv6 协议及家庭路由器配置解析

IPv6（Internet Protocol Version
6）作为下一代互联网协议，通过其扩展的地址空间和优化的协议设计，逐步取代 IPv4。在家庭路由器的配置中，理解 IPv6 的关键参数和协议是实现高效网络管理的核心。以下结合 IPv6 协议生态，系统性地解析其核心概念和应用场景。

---

### **1. GUA（Global Unicast Address，全球单播地址）**

**定义**：GUA 是 IPv6 中用于公网通信的地址（对应 IPv4 公网地址），具有全局唯一性，可以直接在互联网上路由。它是 IPv6 设备的主要“身份证”，用于与全球其他设备通信。

| 获取方式（Method）                | 中文名称（Chinese Name）      | 配置方法（Configuration）                                   | 优点（Advantages）    | 缺点（Disadvantages）   |
| --------------------------------- | ----------------------------- | ----------------------------------------------------------- | --------------------- | ----------------------- |
| 无状态地址获取（SLAAC）           | 无状态地址自动配置            | 基于 RA 消息中的前缀生成 GUA（接口 ID + 前缀）              | 无需服务器，配置简单  | 无法分配 DNS 等额外信息 |
| DHCPv6 有状态（Stateful DHCPv6）  | 动态主机配置协议版本 6 有状态 | 由 DHCPv6 服务器分配完整地址和配置                          | 可集中管理地址和 DNS  | 需部署 DHCPv6 服务器    |
| DHCPv6 无状态（Stateless DHCPv6） | 动态主机配置协议版本 6 无状态 | 通过 RA 获取前缀，DHCPv6 仅提供 DNS                         | 结合 SLAAC 与集中管理 | 仍需部署 DHCPv6 服务器  |
| 从前缀获取（Prefix-based）        | 基于前缀分配                  | 路由器从 ISP（Internet Service Provider）获取前缀并划分子网 | 灵活分配子网资源      | 需要手动或半自动配置    |

**典型流程**：  
家庭路由器通常从 ISP 获取一个主前缀（如 `/56`），再通过子网划分（如
`/64`）为局域网设备分配 GUA。设备根据 RA 消息中的前缀信息（含 M/O 标志位）选择 SLAAC 或 DHCPv6 进行地址生成。

---

### **2. LLA（Link-Local Address，链路本地地址）**

**定义**：  
LLA是仅在同一链路（局域网）内有效的地址，格式为`fe80::/10`，用于本地通信（如邻居发现、ARP替代功能）。

**生成方式**：

- 自动配置，通常基于接口的 MAC 地址生成（EUI-64 格式），或通过手动配置。
- **不可路由**：路由器不会转发 LLA 数据包，仅用于同一链路内的设备通信。

**意义**：

- **邻居发现协议（NDP）**：LLA 是 NDP 的基础，用于地址解析（类似 IPv4 的 ARP）、重复地址检测（DAD）等。
- **局域网管理**：即使没有 GUA，设备仍可通过LLA进行本地通信（如配置路由器时使用`fe80::1`）。

---

### **3. IAPD 前缀（IPv4 Address Plus Domain）**

**定义**：  
IAPD 是 IPv6 过渡技术中的一种机制，用于在 IPv6 网络中嵌入 IPv4 地址信息，通常与 6to4 或 ISATAP 隧道技术结合使用。

- **格式**：`2002:IPv4地址::/48`（例如，IPv4地址`192.0.2.1`对应的IPv6地址为`2002:c000:0201::/48`）。
- **作用**：允许 IPv6 节点通过隧道封装 IPv4 流量，实现 IPv4 与IPv6的互通。

**意义**：

- **过渡阶段的桥梁**：在 IPv4 地址枯竭后，IAPD 前缀帮助 IPv6 网络与遗留 IPv4 服务兼容。
- **家庭网络中的应用**：部分路由器支持通过 IAPD 前缀为局域网设备分配 IPv4 兼容的 IPv6 地址（如 IPv4 映射地址）。

---

### **4. RA 前缀（Router Advertisement Prefix）**

**定义**：  
RA 是路由器通过 NDP 协议广播的消息，其中包含网络前缀信息（如`2001:db8::/64`），供主机生成 GUA。

**关键参数**：

- **前缀长度**（Prefix Length）：如`/64`，定义子网划分范围。
- **生命周期**（Valid/Preferred Lifetime）：指示地址的有效时间和推荐使用时间。
- **M/O标志位**：
  - **M标志（Managed Address Configuration）**：是否启用 DHCPv6 有状态配置。
  - **O标志（Other Configuration）**：是否启用 DHCPv6 无状态配置（仅分配 DNS 等信息）。

**意义**：

- **自动配置核心**：RA 消息是 SLAAC 和 DHCPv6 的基础，确保设备无需手动配置即可获取 IPv6 地址。
- **网络管理**：路由器通过调整 RA 参数（如前缀、生命周期）控制地址分配策略。

---

### **5. Unnumbered 模式（未编号模式）**

**定义**：  
Unnumbered 模式下，接口不配置独立的 IPv6 地址，而是借用其他接口的地址（通常是 LLA 或 GUA）进行通信。

**应用场景**：

- **OSPFv3**：在链路状态路由协议中，接口可能仅需链路本地地址（LLA）进行邻居发现，而无需额外分配 GUA。
- **节省地址资源**：在 IPv6 地址充足的情况下，Unnumbered 模式减少地址浪费。

**意义**：

- **简化配置**：无需为每个接口分配独立地址，降低管理复杂度。
- **兼容性**：适用于某些路由协议（如 OSPFv3）对地址分配的特殊需求。

---

### **IPv6协议生态中的关键协议**

1. **NDP（Neighbor Discovery Protocol，邻居发现协议）**：

   - **功能**：替代 IPv4 的 ARP、ICMP 路由器请求/通告等功能，实现地址解析、路由器发现、重复地址检测等。
   - **依赖LLA**：所有 NDP 消息均通过 LLA 发送。

2. **DHCPv6**：

   - **有状态 vs. 无状态**：
     - 有状态：分配 IPv6 地址、DNS 等（需服务器）。
     - 无状态：仅分配 DNS 等辅助信息（需 RA 中的 O 标志启用）。
   - **灵活性**：可根据网络需求选择配置模式。

3. **SLAAC（Stateless Address Autoconfiguration，无状态地址自动配置）**：

   - **流程**：主机通过 RA 获取前缀，结合接口 ID 生成 GUA。
   - **优势**：零配置，适合家庭网络中的即插即用设备。

4. **IPsec（Internet Protocol Security）**：

   - **内置安全**：IPv6 强制支持 IPsec，提供端到端的数据加密和认证，增强网络安全性。

5. **OSPFv3**:

- IPv6 网络中的链路路由协议

**协议协同作用**：  
NDP 是 IPv6 的基石协议，通过链路本地地址（LLA，Link-Local Address）实现邻居发现和地址解析。

SLAAC 与 DHCPv6 协同工作，提供灵活的地址分配策略：SLAAC 无需服务器即可生成 GUA，而 DHCPv6 可集中管理地址和 DNS。

IPsec 在 IPv6 中被强制支持，确保通信安全性。

---

### **家庭路由器中的典型配置流程**

1. **从ISP获取前缀**：  
   路由器通过 PPPoE 或 DHCPv6 从 ISP 获取 IPv6 前缀（如`2001:db8::/56`）。

2. **分配子网前缀**：  
   路由器将前缀划分为多个子网（如`2001:db8:0:1::/64`），分配给局域网设备。

3. **发送 RA 消息**：  
   路由器周期性广播 RA 消息，包含前缀信息、M/O 标志等，触发设备自动生成 GUA 或通过 DHCPv6 获取配置。

4. **LLA自动配置**：  
   所有接口自动生成 LLA，用于本地通信和 NDP 操作。
